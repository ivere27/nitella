FROM golang:1.24-alpine AS builder

RUN apk add --no-cache gcc musl-dev sqlite-dev

WORKDIR /app
COPY go.mod go.sum ./
RUN go mod download

COPY . .

# Build test binaries (single package only)
RUN go test -c -o e2e_tests ./test/e2e
RUN go build -o nitella ./cmd/nitella
RUN go build -o hubctl ./cmd/hubctl

FROM alpine:3.19
RUN apk add --no-cache ca-certificates sqlite netcat-openbsd curl bash jq

WORKDIR /app
COPY --from=builder /app/e2e_tests .
COPY --from=builder /app/nitella .
COPY --from=builder /app/hubctl .
COPY test/e2e/scripts/ ./scripts/
COPY test/e2e/run_e2e_tests.sh .

RUN chmod +x run_e2e_tests.sh scripts/*.sh

ENTRYPOINT ["./run_e2e_tests.sh"]
