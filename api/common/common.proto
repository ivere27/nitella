syntax = "proto3";

package nitella;

option go_package = "github.com/ivere27/nitella/pkg/api/common";

// ActionType defines the possible actions for rules and defaults
enum ActionType {
  ACTION_TYPE_UNSPECIFIED = 0;
  ACTION_TYPE_ALLOW = 1;
  ACTION_TYPE_BLOCK = 2;
  ACTION_TYPE_MOCK = 3;
  ACTION_TYPE_REQUIRE_APPROVAL = 4;  // Real-time user approval required
}

// FallbackAction defines what to do when a primary action fails or is not applicable
enum FallbackAction {
  FALLBACK_ACTION_UNSPECIFIED = 0;
  FALLBACK_ACTION_CLOSE = 1;
  FALLBACK_ACTION_MOCK = 2;
}

// MockPreset defines pre-configured mock responses
enum MockPreset {
  MOCK_PRESET_UNSPECIFIED = 0;
  MOCK_PRESET_SSH_SECURE = 1;
  MOCK_PRESET_SSH_TARPIT = 2;
  MOCK_PRESET_HTTP_403 = 3;
  MOCK_PRESET_HTTP_404 = 4;
  MOCK_PRESET_HTTP_401 = 5;
  MOCK_PRESET_REDIS_SECURE = 6;
  MOCK_PRESET_MYSQL_SECURE = 7;
  MOCK_PRESET_MYSQL_TARPIT = 8;
  MOCK_PRESET_RDP_SECURE = 9;
  MOCK_PRESET_TELNET_SECURE = 10;
  MOCK_PRESET_RAW_TARPIT = 11;
}

// ConditionType defines the type of condition in a rule
enum ConditionType {
  CONDITION_TYPE_UNSPECIFIED = 0;
  CONDITION_TYPE_SOURCE_IP = 1;
  CONDITION_TYPE_GEO_COUNTRY = 2;
  CONDITION_TYPE_GEO_CITY = 3;
  CONDITION_TYPE_GEO_ISP = 4;
  CONDITION_TYPE_TIME_RANGE = 5;        // Format: "HH:MM-HH:MM" (24h)
  CONDITION_TYPE_TLS_FINGERPRINT = 6;
  CONDITION_TYPE_TLS_CN = 7;
  CONDITION_TYPE_TLS_SERIAL = 8;
  CONDITION_TYPE_TLS_PRESENT = 9;       // Client presented any valid cert (value: "true" or "false")
  CONDITION_TYPE_TLS_CA = 10;           // Issuing CA CommonName matches
  CONDITION_TYPE_TLS_SAN = 11;          // Subject Alternative Name matches (DNS or email)
  CONDITION_TYPE_TLS_OU = 12;           // Organizational Unit matches
}

// Operator defines how to match the value in a condition
enum Operator {
  OPERATOR_UNSPECIFIED = 0;
  OPERATOR_EQ = 1;      // Equals
  OPERATOR_CONTAINS = 2;// String contains
  OPERATOR_REGEX = 3;   // Regular expression
  OPERATOR_CIDR = 4;    // IP CIDR match (e.g., 192.168.1.0/24)
}

// SortOrder defines sorting options for statistics queries
enum SortOrder {
  SORT_LAST_SEEN_DESC = 0;            // Default
  SORT_LAST_SEEN_ASC = 1;
  SORT_CONNECTION_COUNT_DESC = 2;
  SORT_BYTES_TOTAL_DESC = 3;
  SORT_RECENCY_WEIGHT_DESC = 4;
}

// ===========================================================================
// HUB-RELATED TYPES (for E2E encryption and approval workflow)
// ===========================================================================

// PemLabel defines PEM block types
enum PemLabel {
  PEM_LABEL_UNSPECIFIED = 0;
  PEM_LABEL_CERTIFICATE = 1;
  PEM_LABEL_PUBLIC_KEY = 2;
  PEM_LABEL_PRIVATE_KEY = 3;
  PEM_LABEL_ENCRYPTED_PRIVATE_KEY = 4;
}

// ApprovalActionType defines the user's decision for an approval request
enum ApprovalActionType {
  APPROVAL_ACTION_TYPE_UNSPECIFIED = 0;
  APPROVAL_ACTION_TYPE_ALLOW = 1;          // Allow connection
  APPROVAL_ACTION_TYPE_BLOCK = 2;          // Block connection
  APPROVAL_ACTION_TYPE_BLOCK_ADD_RULE = 3; // Block and create permanent rule
}

// ApprovalRetentionMode controls whether an approval decision is cached or
// applied only to the current pending connection.
enum ApprovalRetentionMode {
  APPROVAL_RETENTION_MODE_UNSPECIFIED = 0;      // Fallback to CACHE mode
  APPROVAL_RETENTION_MODE_CACHE = 1;            // Cache decision for duration_seconds
  APPROVAL_RETENTION_MODE_CONNECTION_ONLY = 2;  // No cache; duration_seconds is max connection lifetime
}

// P2PMode defines the peer-to-peer connection strategy
enum P2PMode {
  P2P_MODE_UNSPECIFIED = 0;
  P2P_MODE_AUTO = 1;    // Try P2P first, fallback to Hub if fails
  P2P_MODE_DIRECT = 2;  // P2P only, show error if fails (no fallback)
  P2P_MODE_HUB = 3;     // Hub relay only, no P2P
}

// CryptoAlgorithm for forward compatibility
enum CryptoAlgorithm {
  ALGO_UNKNOWN = 0;
  ALGO_ED25519 = 1; // Ed25519 Signing + X25519 ECDH + AES-GCM Encryption
}

// EncryptedPayload wraps E2E encrypted data using X25519 ECDH + AES-256-GCM.
// The sender generates an ephemeral X25519 keypair, derives a shared secret
// with the recipient's public key using ECDH, then encrypts with AES-GCM.
message EncryptedPayload {
  bytes ephemeral_pubkey = 1;    // X25519 ephemeral public key (32 bytes)
  bytes nonce = 2;               // AES-GCM nonce (12 bytes)
  bytes ciphertext = 3;          // AES-256-GCM encrypted payload with auth tag
  string sender_fingerprint = 4; // SHA256 of sender's cert for key lookup
  bytes signature = 5;           // Ed25519 signature of ciphertext (optional)
  CryptoAlgorithm algorithm = 6; // Algorithm identifier for forward compat
}

// SecureCommandPayload is the inner structure that gets encrypted.
// It includes anti-replay fields that are only visible after decryption.
message SecureCommandPayload {
  string request_id = 1;          // Unique ID for this request
  int64 timestamp = 2;            // Unix timestamp (seconds)
  bytes data = 3;                 // The actual command content
}

// Alert (encrypted content for Zero-Trust)
message Alert {
  string id = 1;
  string node_id = 2;
  // Plaintext fields for Hub routing only
  string severity = 3; // info, warning, critical (Hub needs this for priority)
  int64 timestamp_unix = 4;
  bool acknowledged = 5;
  // Encrypted content (title, description) - only Mobile can decrypt
  EncryptedPayload encrypted = 6;
  map<string, string> metadata = 7; // Routing info (e.g. type=approval, tag=production)
}

// AlertDetails contains encrypted alert information for approval requests.
// This replaces JSON-encoded alert info for type safety.
message AlertDetails {
    string source_ip = 1;
    string destination = 2;
    string proxy_id = 3;
    string proxy_name = 4;
    string rule_id = 5;
    string geo_country = 6;
    string geo_city = 7;
    string geo_isp = 8;
}

// GeoInfo contains geographical information for an IP address.
message GeoInfo {
  string country = 1;
  string city = 2;
  string isp = 3;

  // Extended fields
  string country_code = 4;
  string region = 5;
  string region_name = 6;
  string zip = 7;
  double latitude = 8;
  double longitude = 9;
  string timezone = 10;
  string org = 11;
  string as = 12;

  // Metadata
  string source = 13;    // e.g., "cache-l1", "cache-l2", "local-db", "remote:ip-api"
  int64 latency_ms = 14;
}
