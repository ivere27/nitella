# Nitella Hub

The Hub is a central relay server that enables secure remote management of nitellad nodes. It acts as a "blind relay" - all sensitive data is end-to-end encrypted and the Hub cannot read command payloads or metrics.

## Architecture

### High-Level Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   nitella CLI    â”‚                    â”‚   Hub Server     â”‚
â”‚   (or Mobile)    â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚   (Blind Relay)  â”‚
â”‚                  â”‚     E2E Encrypted  â”‚                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                 â”‚ mTLS
                                                 â–¼
                                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                        â”‚   nitellad       â”‚
                                        â”‚   (Proxy Node)   â”‚
                                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Key Principles

1. **Zero Trust Hub**: The Hub cannot decrypt commands or metrics. It only relays encrypted payloads.
2. **mTLS Authentication**: Nodes authenticate using client certificates signed by the user's CA.
3. **P2P First**: When possible, clients connect directly to nodes via WebRTC, bypassing the Hub.
4. **Mobile as Root CA**: In full deployment, the mobile device holds the Root CA private key.
5. **Blind Routing**: Hub routes messages using opaque routing tokens - it cannot correlate tokens to user identity.

---

## Zero-Trust Routing Token Architecture

The Hub operates as a **"dumb relay"** that cannot correlate which user owns which node. This is achieved through blind routing tokens.

### Why Routing Tokens?

Without routing tokens, the Hub could:
- Build user activity profiles
- Correlate node ownership patterns
- Become a single point of compromise for user privacy

With routing tokens:
- Hub sees only opaque tokens (random-looking strings)
- Hub cannot derive user identity from tokens
- Each user's tokens are cryptographically isolated

### Routing Token Derivation

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     CLI (Local Storage Only)                        â”‚
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  userSecret = random(32 bytes)                              â”‚   â”‚
â”‚  â”‚  (Generated once, stored locally, NEVER sent to Hub)        â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                              â”‚                                      â”‚
â”‚                              â–¼                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  For each paired node:                                      â”‚   â”‚
â”‚  â”‚                                                             â”‚   â”‚
â”‚  â”‚    routingToken = HMAC-SHA256(nodeID, userSecret)           â”‚   â”‚
â”‚  â”‚                                                             â”‚   â”‚
â”‚  â”‚    Example:                                                 â”‚   â”‚
â”‚  â”‚      nodeID = "my-laptop"                                   â”‚   â”‚
â”‚  â”‚      userSecret = 0x1a2b3c...                               â”‚   â”‚
â”‚  â”‚      routingToken = "a7f3b2c1d4e5..."  (64 hex chars)       â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                     â”‚
â”‚  Stored: ~/.nitella/user_secret (encrypted)                        â”‚
â”‚          ~/.nitella/routing_tokens.json                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Command Flow with Routing Tokens

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   CLI       â”‚         â”‚    HUB      â”‚         â”‚  nitellad   â”‚
â”‚             â”‚         â”‚(Blind Relay)â”‚         â”‚   (Node)    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚                       â”‚                       â”‚
       â”‚  SendCommand {        â”‚                       â”‚
       â”‚    routing_token: "a7f3b2..."                 â”‚
       â”‚    encrypted: <E2E blob>                      â”‚
       â”‚  }                    â”‚                       â”‚
       â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                       â”‚
       â”‚                       â”‚                       â”‚
       â”‚                       â”‚  Hub looks up node    â”‚
       â”‚                       â”‚  by routing_token     â”‚
       â”‚                       â”‚  (no user info!)      â”‚
       â”‚                       â”‚                       â”‚
       â”‚                       â”‚  Forward encrypted    â”‚
       â”‚                       â”‚  payload              â”‚
       â”‚                       â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
       â”‚                       â”‚                       â”‚
       â”‚                       â”‚                       â”‚  Decrypt with
       â”‚                       â”‚                       â”‚  shared key
       â”‚                       â”‚                       â”‚
       â”‚                       â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
       â”‚                       â”‚  Encrypted response   â”‚
       â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                       â”‚
       â”‚                       â”‚                       â”‚
```

### What Hub Sees vs What Hub Cannot See

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         HUB DATABASE                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  Nodes Table:                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ routing_token  â”‚ encrypted_metadata  â”‚ status               â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚ a7f3b2c1d4...  â”‚ <encrypted blob>    â”‚ online               â”‚   â”‚
â”‚  â”‚ x9y8z7w6v5...  â”‚ <encrypted blob>    â”‚ offline              â”‚   â”‚
â”‚  â”‚ m1n2o3p4q5...  â”‚ <encrypted blob>    â”‚ online               â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                     â”‚
â”‚  Hub CAN see:     âœ“ routing_token (opaque string)                  â”‚
â”‚                   âœ“ node status (online/offline)                   â”‚
â”‚                   âœ“ connection timestamps                          â”‚
â”‚                                                                     â”‚
â”‚  Hub CANNOT see:  âœ— userSecret (never leaves CLI)                  â”‚
â”‚                   âœ— which user owns which node                     â”‚
â”‚                   âœ— node names, IPs, or metadata (E2E encrypted)   â”‚
â”‚                   âœ— command contents (E2E encrypted)               â”‚
â”‚                   âœ— metrics data (E2E encrypted)                   â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Multi-User Isolation

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                     â”‚
â”‚  Alice (userSecret_A)              Bob (userSecret_B)               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚ nodeID: "laptop"    â”‚          â”‚ nodeID: "laptop"    â”‚          â”‚
â”‚  â”‚                     â”‚          â”‚                     â”‚          â”‚
â”‚  â”‚ HMAC(laptop, sec_A) â”‚          â”‚ HMAC(laptop, sec_B) â”‚          â”‚
â”‚  â”‚         â”‚           â”‚          â”‚         â”‚           â”‚          â”‚
â”‚  â”‚         â–¼           â”‚          â”‚         â–¼           â”‚          â”‚
â”‚  â”‚ token: "a7f3b2..."  â”‚          â”‚ token: "x9y8z7..."  â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚           â”‚                                â”‚                        â”‚
â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚
â”‚                        â–¼    â–¼                                       â”‚
â”‚                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                   â”‚
â”‚                   â”‚     HUB     â”‚                                   â”‚
â”‚                   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                                   â”‚
â”‚                   â”‚ Sees only:  â”‚                                   â”‚
â”‚                   â”‚ â€¢ a7f3b2... â”‚  â† Cannot tell this is Alice's    â”‚
â”‚                   â”‚ â€¢ x9y8z7... â”‚  â† Cannot tell this is Bob's      â”‚
â”‚                   â”‚             â”‚                                   â”‚
â”‚                   â”‚ Cannot:     â”‚                                   â”‚
â”‚                   â”‚ â€¢ Link tokens to users                          â”‚
â”‚                   â”‚ â€¢ Know both are named "laptop"                  â”‚
â”‚                   â”‚ â€¢ Correlate ownership                           â”‚
â”‚                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                   â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Node Pairing Flow

### PAKE (Password-Authenticated Key Exchange) Pairing

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    CLI      â”‚                                       â”‚  nitellad   â”‚
â”‚   (Alice)   â”‚                                       â”‚   (Node)    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                                       â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚                                                     â”‚
       â”‚  1. Generate pairing code: "APPLE-BEACH-CORAL"      â”‚
       â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
       â”‚     (User reads code aloud or types it)             â”‚
       â”‚                                                     â”‚
       â”‚  2. Both derive PAKE session from code              â”‚
       â”‚     cliSession = PAKE(code, role=CLI)               â”‚
       â”‚     nodeSession = PAKE(code, role=Node)             â”‚
       â”‚                                                     â”‚
       â”‚  3. Exchange PAKE init messages                     â”‚
       â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
       â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
       â”‚                                                     â”‚
       â”‚  4. Derive shared key + confirmation emoji          â”‚
       â”‚     CLI shows: "ğŸğŸ–ï¸ğŸª¸"                              â”‚
       â”‚     Node shows: "ğŸğŸ–ï¸ğŸª¸"                             â”‚
       â”‚     (User verifies they match)                      â”‚
       â”‚                                                     â”‚
       â”‚  5. Node sends encrypted CSR                        â”‚
       â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€[ E2E Encrypted ]â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
       â”‚                                                     â”‚
       â”‚  6. CLI signs CSR with Root CA                      â”‚
       â”‚     CLI generates: routingToken = HMAC(nodeID, userSecret)
       â”‚                                                     â”‚
       â”‚  7. CLI sends encrypted cert + routing token        â”‚
       â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€[ E2E Encrypted ]â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
       â”‚                                                     â”‚
       â”‚  8. Node stores cert, connects to Hub               â”‚
       â”‚     CLI stores routingToken locally                 â”‚
       â”‚                                                     â”‚
       â–¼                                                     â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                           HUB                               â”‚
  â”‚  Receives: routingToken (during ApproveNode)                â”‚
  â”‚  Stores: routing_token â†” node mapping                       â”‚
  â”‚  Does NOT know: which user, what the node name is           â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### QR Code / Offline Pairing (Air-Gapped)

There are two modes for offline pairing:

#### Web UI Mode (Recommended for Docker)

```bash
# Start nitellad with pairing web UI
docker run -p 8888:8888 nitellad --hub hub.example.com:50052 \
  --pair-offline --pair-port :8888
```

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  nitellad startup                                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  1. Generate node keypair + CSR                                     â”‚
â”‚  2. Generate CPACE words for authentication                         â”‚
â”‚  3. Generate temporary TLS cert for HTTPS                           â”‚
â”‚  4. Start HTTPS server on :8888                                     â”‚
â”‚  5. Print to stdout (docker logs):                                  â”‚
â”‚                                                                     â”‚
â”‚  â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—  â”‚
â”‚  â•‘  CPACE Words:  7-tiger-castle                                â•‘  â”‚
â”‚  â•‘  Fingerprint:  ğŸ¶ğŸŒ¸ğŸ¸â­                                       â•‘  â”‚
â”‚  â•‘  Web UI:       https://localhost:8888                        â•‘  â”‚
â”‚  â•‘  Timeout:      3 minutes                                     â•‘  â”‚
â”‚  â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•  â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  User opens https://localhost:8888 in browser                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  Step 1: Enter CPACE words (from docker logs)                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚   Enter CPACE words: [7-tiger-castle]  [Verify]             â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                     â”‚
â”‚  Step 2: Scan QR or paste signed certificate                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚   [QR CODE]  Fingerprint: ğŸ¶ğŸŒ¸ğŸ¸â­                          â”‚   â”‚
â”‚  â”‚                                                             â”‚   â”‚
â”‚  â”‚   Paste certificate: [________________]  [Submit]           â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                     â”‚
â”‚  Step 3: Verify CA fingerprint                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚   âš ï¸ VERIFY THIS MATCHES YOUR CLI:                          â”‚   â”‚
â”‚  â”‚   CA Fingerprint: ğŸ¦ŠğŸŒºğŸ¹ğŸŒ™                                  â”‚   â”‚
â”‚  â”‚                                                             â”‚   â”‚
â”‚  â”‚   [Cancel]  [Confirm]                                       â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â”‚ After confirmation
                                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Pairing complete                                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  â€¢ Pairing port closed (8888)                                       â”‚
â”‚  â€¢ Connect to Hub with mTLS                                         â”‚
â”‚  â€¢ NO listening ports (until proxy configured)                      â”‚
â”‚  â€¢ Wait for commands from CLI via Hub                               â”‚
â”‚                                                                     â”‚
â”‚  stdout:                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  [Pairing] Complete! CA fingerprint: ğŸ¦ŠğŸŒºğŸ¹ğŸŒ™               â”‚   â”‚
â”‚  â”‚  [Hub] Connected to hub.example.com:50052                   â”‚   â”‚
â”‚  â”‚  [Hub] Waiting for commands...                              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### Terminal Mode (Interactive)

```bash
# Start nitellad with terminal-based pairing
nitellad --hub hub.example.com:50052 --pair-offline
```

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    CLI      â”‚                              â”‚  nitellad   â”‚
â”‚  (Phone)    â”‚                              â”‚  (Server)   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                              â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚                                            â”‚
       â”‚         1. nitellad outputs CSR           â”‚
       â”‚            (QR on screen + JSON)          â”‚
       â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€ User looks at screen â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
       â”‚                                            â”‚
       â”‚  2. CLI scans QR (phone camera)            â”‚
       â”‚     or user copies JSON text               â”‚
       â”‚                                            â”‚
       â”‚  3. CLI signs CSR, outputs cert            â”‚
       â”‚     (as JSON)                              â”‚
       â”‚                                            â”‚
       â”‚         4. User PASTES JSON text           â”‚
       â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ into nitellad terminal â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
       â”‚                                            â”‚
       â”‚         5. nitellad reads via stdin        â”‚
       â”‚            parses JSON, saves cert         â”‚
       â”‚            connects to Hub                 â”‚
       â”‚                                            â”‚
```

---

## E2E Encryption Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    CLI â†’ Node Command Encryption                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  CLI has: Node's public key (from cert)
  Node has: CLI's public key (from Root CA)

  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚    CLI      â”‚
  â”‚             â”‚
  â”‚  1. Generate ephemeral X25519 keypair                             â”‚
  â”‚     ephemeral_priv, ephemeral_pub = X25519.Generate()             â”‚
  â”‚                                                                   â”‚
  â”‚  2. ECDH with node's public key                                   â”‚
  â”‚     shared = X25519(ephemeral_priv, node_pub)                     â”‚
  â”‚                                                                   â”‚
  â”‚  3. Derive encryption key                                         â”‚
  â”‚     key = HKDF-SHA256(shared, "nitella-cmd")                      â”‚
  â”‚                                                                   â”‚
  â”‚  4. Encrypt command                                               â”‚
  â”‚     nonce = random(12 bytes)                                      â”‚
  â”‚     ciphertext = AES-256-GCM(key, nonce, plaintext)               â”‚
  â”‚                                                                   â”‚
  â”‚  5. Send to Hub                                                   â”‚
  â”‚     {                                                             â”‚
  â”‚       ephemeral_pub: <32 bytes>,                                  â”‚
  â”‚       nonce: <12 bytes>,                                          â”‚
  â”‚       ciphertext: <encrypted command>                             â”‚
  â”‚     }                                                             â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚    HUB      â”‚  Sees only: opaque encrypted blob
  â”‚             â”‚  Cannot: decrypt, read command, know contents
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚   Node      â”‚
  â”‚             â”‚
  â”‚  1. Extract ephemeral_pub from message                            â”‚
  â”‚                                                                   â”‚
  â”‚  2. ECDH with node's private key                                  â”‚
  â”‚     shared = X25519(node_priv, ephemeral_pub)                     â”‚
  â”‚                                                                   â”‚
  â”‚  3. Derive same encryption key                                    â”‚
  â”‚     key = HKDF-SHA256(shared, "nitella-cmd")                      â”‚
  â”‚                                                                   â”‚
  â”‚  4. Decrypt command                                               â”‚
  â”‚     plaintext = AES-256-GCM.Open(key, nonce, ciphertext)          â”‚
  â”‚                                                                   â”‚
  â”‚  5. Execute command, encrypt response the same way                â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Complete System Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              USER DEVICES                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚      Mobile App         â”‚         â”‚      nitella CLI        â”‚           â”‚
â”‚  â”‚  (Root CA holder)       â”‚         â”‚                         â”‚           â”‚
â”‚  â”‚                         â”‚         â”‚                         â”‚           â”‚
â”‚  â”‚  â€¢ Root CA private key  â”‚         â”‚  â€¢ userSecret           â”‚           â”‚
â”‚  â”‚  â€¢ Signs node certs     â”‚         â”‚  â€¢ routingTokens        â”‚           â”‚
â”‚  â”‚  â€¢ E2E encryption keys  â”‚         â”‚  â€¢ E2E encryption keys  â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚              â”‚                                   â”‚                          â”‚
â”‚              â”‚ JWT + mTLS                        â”‚ JWT + mTLS               â”‚
â”‚              â”‚                                   â”‚                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚                                   â”‚
               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                            HUB SERVER                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚  AuthService    â”‚  â”‚  MobileService  â”‚  â”‚  NodeService    â”‚             â”‚
â”‚  â”‚                 â”‚  â”‚                 â”‚  â”‚                 â”‚             â”‚
â”‚  â”‚  â€¢ Register     â”‚  â”‚  â€¢ ListNodes    â”‚  â”‚  â€¢ Register     â”‚             â”‚
â”‚  â”‚  â€¢ Login        â”‚  â”‚  â€¢ SendCommand  â”‚  â”‚  â€¢ WatchReg     â”‚             â”‚
â”‚  â”‚  â€¢ RefreshToken â”‚  â”‚  â€¢ StreamMetric â”‚  â”‚  â€¢ ReceiveCmd   â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                         DATABASE                                     â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â”‚  routing_tokens â”€â”€â–º nodes (encrypted_metadata, status)              â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â”‚  NO user â†” node correlation!                                        â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â”‚ mTLS (node cert signed by user's CA)
               â”‚
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           NODES (nitellad)                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚  â”‚   Node A (laptop)       â”‚     â”‚   Node B (server)       â”‚               â”‚
â”‚  â”‚                         â”‚     â”‚                         â”‚               â”‚
â”‚  â”‚  â€¢ Node private key     â”‚     â”‚  â€¢ Node private key     â”‚               â”‚
â”‚  â”‚  â€¢ Cert (signed by CA)  â”‚     â”‚  â€¢ Cert (signed by CA)  â”‚               â”‚
â”‚  â”‚  â€¢ CLI CA cert          â”‚     â”‚  â€¢ CLI CA cert          â”‚               â”‚
â”‚  â”‚                         â”‚     â”‚                         â”‚               â”‚
â”‚  â”‚  Decrypts E2E commands  â”‚     â”‚  Decrypts E2E commands  â”‚               â”‚
â”‚  â”‚  Encrypts E2E responses â”‚     â”‚  Encrypts E2E responses â”‚               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Components

| Component | Binary | Description |
|-----------|--------|-------------|
| Hub Server | `hub` | Central relay, user auth, push notifications |
| Hub Admin CLI | `hubctl` | Administration tool for Hub operators |
| Nitella CLI | `nitella` | Client CLI with Hub mode for remote management |
| Nitella Daemon | `nitellad` | Proxy daemon with Hub registration support |

## Quick Start

### 1. Start the Hub Server

```bash
# Default (auto-cert mode - generates self-signed CA)
./hub --port 50052 --db-path hub.db

# With well-known CA (Let's Encrypt, etc.)
# Falls back to auto-cert if certificate loading fails
./hub --port 50052 \
  --tls-cert /path/to/cert.pem \
  --tls-key /path/to/key.pem \
  --db-path hub.db

# Full production setup (well-known CA + mTLS + DB encryption)
./hub --port 50052 \
  --tls-cert /path/to/cert.pem \
  --tls-key /path/to/key.pem \
  --tls-ca /path/to/ca.pem \
  --require-mtls \
  --db-path hub.db \
  --db-encryption-key=$(cat /path/to/db.key)
```

### 2. Create Admin Token

```bash
# Using hubctl with self-signed Hub CA (auto-generated in data dir)
./hubctl --hub localhost:50052 --tls-ca ./hub_ca.crt token generate-admin

# Or check Hub server logs for auto-generated token
```

### 3. Pair and Run a Node

```bash
# Option 1: PAKE pairing (interactive, with code from CLI)
nitellad --hub hub.example.com:50052 --pair 7-tiger-castle

# Option 2: Offline pairing with Web UI (for Docker)
docker run -p 8888:8888 nitellad \
  --hub hub.example.com:50052 \
  --pair-offline --pair-port :8888 \
  --pair-timeout 5m

# Option 3: Offline pairing with terminal (interactive)
nitellad --hub hub.example.com:50052 --pair-offline

# After pairing, run normally (no --pair flags)
# Note: nitellad does NOT listen on any port by default
# Proxies are configured via CLI commands, config file, or flags
nitellad --hub hub.example.com:50052

# With explicit proxy (opens port 8080)
nitellad --hub hub.example.com:50052 --listen :8080 --backend app:3000

# With config file
nitellad --hub hub.example.com:50052 --config proxies.yaml
```

### 4. Manage Nodes via CLI

```bash
# Configure Hub connection
nitella config set hub hub.example.com:50052
nitella login

# List nodes
nitella nodes

# Send command to node
nitella send <node-id> status
```

## Hub Server Configuration

### Command-Line Flags

```
Server Options:
  -port int              gRPC server port (default 50052)
  -http-port int         HTTP health check port (default 8080)

Database:
  -db-driver string      Database driver: sqlite3, mysql, postgres (default "sqlite3")
  -db-path string        Database path/connection string (default "hub.db")
  -db-encryption-key     Database encryption key (32 bytes as 64-char hex string)

TLS:
  -auto-cert             Force auto-generate TLS certs (default: false)
                         Auto-cert is used as fallback if --tls-cert/--tls-key fail
  -tls-cert string       Path to TLS certificate
  -tls-key string        Path to TLS private key
  -tls-ca string         Path to CA certificate for client verification
  -cert-data-dir string  Directory for auto-cert storage (default: same as db)
  -require-mtls          Require mTLS for node connections

JWT:
  -jwt-key string        Path to JWT signing key (Ed25519)
  -jwt-data-dir string   Directory for JWT key storage

Firebase (Optional):
  -firebase-credentials  Path to Firebase service account JSON

Logging:
  -verbose               Enable verbose logging
  -trace                 Enable trace logging
```

### TLS Behavior

Hub always runs with TLS enabled. TLS only.

| Configuration | Behavior |
|---------------|----------|
| No flags | Auto-cert mode (generates self-signed CA) |
| `--tls-cert` + `--tls-key` | Manual TLS (fallback to auto-cert on failure) |
| `--auto-cert` | Force auto-cert mode |

**Examples:**
```bash
./hub                              # auto-cert (no certs provided)
./hub --tls-cert=x --tls-key=y     # manual TLS, fallback to auto-cert on failure
./hub --auto-cert                  # force auto-cert mode
```

### Environment Variables

```bash
export DATABASE_URL="postgres://user:pass@localhost/hubdb"  # For postgres
export FIREBASE_CREDENTIALS="/path/to/firebase.json"
export NITELLA_DB_KEY="<64-char-hex-string>"  # Database encryption key (optional)
```

### Database Encryption

Hub supports optional AES-256-GCM encryption for sensitive metadata at rest (e.g., license keys). This is **recommended for production** but optional.

**Generating an encryption key:**

```bash
# Generate a 32-byte (256-bit) random key as hex
openssl rand -hex 32
# Example output: a1b2c3d4e5f6...  (64 characters)
```

**Enabling encryption:**

```bash
# Via command-line flag
./hub --db-encryption-key=a1b2c3d4e5f6...

# Via environment variable
export NITELLA_DB_KEY="a1b2c3d4e5f6..."
./hub
```

**Notes:**
- If no key is configured, metadata is stored in plaintext (a warning is logged)
- The key must be exactly 32 bytes (64 hex characters)
- Existing unencrypted data remains readable after enabling encryption
- E2E encrypted payloads (commands, metrics, templates) are always encrypted regardless of this setting

## Node Registration

### Security Model

Registration uses a two-phase approach:

1. **Registration Phase**: Node connects with temporary ephemeral certificate
   - Invite code controls resource usage (rate limiting, quotas)
   - Ephemeral cert only passes TLS handshake - grants no access
   - Node submits CSR and waits for approval

2. **Pairing Phase**: User authenticates and approves via CPACE
   - User verifies node fingerprint out-of-band
   - CPACE provides mutual authentication
   - Hub signs the CSR and returns CA-signed certificate
   - Node replaces ephemeral cert with CA-signed cert (ephemeral is discarded)

After pairing, only the CA-signed certificate is used for all future connections.

### Standard Flow

1. Node generates Ed25519 keypair and CSR
2. Node connects to Hub with ephemeral cert, submits CSR + invite code
3. Hub returns registration code (6 digits)
4. User approves via CLI/mobile with CPACE authentication
5. Hub signs CSR and returns certificate
6. Node stores certificate for future mTLS connections

### QR Code Flow (Air-Gapped)

1. Node generates keypair and CSR
2. Node displays QR code containing CSR
3. User scans QR with mobile app
4. Mobile app signs CSR with Root CA
5. User transfers signed certificate back to node
6. Node stores certificate

## Security

### Hub Certificate Verification

**Hub with well-known CA (Let's Encrypt, etc.):**

Use `--tls-cert` and `--tls-key` flags:
```bash
./hub --tls-cert /path/to/cert.pem --tls-key /path/to/key.pem
```

If certificate loading fails, Hub automatically falls back to auto-cert mode.

CLI behavior:
- Certificate verified against system root CAs automatically
- Shows Hub info without prompting for trust

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘              âœ…  HUB CERTIFICATE VERIFIED                    â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘  Hub:        hub.example.com:50052                           â•‘
â•‘  Subject:    hub.example.com                                 â•‘
â•‘  Issuer:     Let's Encrypt Authority X3                      â•‘
â•‘  Emoji:      ğŸ”¥ ğŸŒŸ ğŸ¸ ğŸš€                                      â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

**Self-hosted Hub (self-signed CA):**

When no TLS certificates are provided, Hub uses auto-cert mode:
```bash
./hub  # Falls back to auto-cert when no --tls-cert/--tls-key
```

1. Hub first launch â†’ generates self-signed CA â†’ displays fingerprint
2. Hub operator shares fingerprint with users out-of-band
3. User first connect â†’ CLI detects self-signed â†’ shows TOFU prompt
4. User verifies fingerprint and accepts
5. Certificate saved locally â†’ future connections verify against saved cert

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘         âš ï¸  FIRST CONNECTION - VERIFY HUB IDENTITY âš ï¸          â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘  Hub:        hub.example.com:50052                           â•‘
â•‘  Subject:    Nitella Hub                                     â•‘
â•‘  Emoji:      ğŸ”¥ ğŸŒŸ ğŸ¸ ğŸš€                                      â•‘
â•‘  SHA-256:    a1b2c3d4...                                     â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘  This Hub uses a self-signed certificate.                    â•‘
â•‘  Verify fingerprint matches Hub operator's published value!  â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Trust this Hub and save certificate? (yes/no):
```

User responsibility: verify fingerprint matches Hub operator's published fingerprint before accepting.

### Certificate Chain

```
Root CA (Mobile/BIP-39 derived)
    â””â”€â”€ Node Certificate (issued during registration)
```

### E2E Encryption

All commands and metrics are encrypted using:
- **Key Exchange**: X25519 ECDH
- **Symmetric**: AES-256-GCM
- **KDF**: HKDF-SHA256 (nil salt is safe - IKM from ECDH is 256-bit entropy)

The Hub only sees encrypted blobs and cannot decrypt them.

### Replay Protection

Commands include:
- Timestamp (60 second window)
- Unique request ID
- Ed25519 signature from CA

## API Reference

### gRPC Services

| Service | Description |
|---------|-------------|
| `NodeService` | Node registration, commands, metrics, signaling |
| `MobileService` | Node listing, command sending, metrics streaming |
| `AuthService` | User registration, login, token refresh |
| `PairingService` | Secure pairing code generation/validation |
| `AdminService` | User/node management, invite codes, stats |

### NodeService Methods

```protobuf
service NodeService {
  rpc Register(NodeRegisterRequest) returns (NodeRegisterResponse);
  rpc WatchRegistration(WatchRegistrationRequest) returns (stream WatchRegistrationResponse);
  rpc ReceiveCommands(ReceiveCommandsRequest) returns (stream Command);
  rpc RespondToCommand(CommandResponse) returns (google.protobuf.Empty);
  rpc PushMetrics(stream EncryptedMetrics) returns (google.protobuf.Empty);
  rpc PushLogs(stream EncryptedLogEntry) returns (google.protobuf.Empty);
  rpc PushAlert(Alert) returns (google.protobuf.Empty);
  rpc StreamSignaling(stream SignalMessage) returns (stream SignalMessage);
  rpc CheckCertificate(CheckCertificateRequest) returns (CheckCertificateResponse);
}
```

### MobileService Methods

```protobuf
service MobileService {
  rpc ListNodes(ListNodesRequest) returns (ListNodesResponse);
  rpc GetNode(GetNodeRequest) returns (GetNodeResponse);
  rpc ApproveNode(ApproveNodeRequest) returns (ApproveNodeResponse);
  rpc RejectNode(RejectNodeRequest) returns (RejectNodeResponse);
  rpc SendCommand(SendCommandRequest) returns (SendCommandResponse);
  rpc StreamMetrics(StreamMetricsRequest) returns (stream EncryptedMetrics);
  rpc StreamSignaling(stream SignalMessage) returns (stream SignalMessage);
}
```

## P2P Mode

When P2P is enabled (default), clients attempt direct WebRTC connections:

1. Client requests P2P connection via Hub signaling
2. Hub relays ICE candidates between client and node
3. If P2P succeeds, traffic bypasses Hub entirely
4. If P2P fails, falls back to Hub relay

### STUN Server Configuration

P2P connections use STUN (Session Traversal Utilities for NAT) servers to discover public IP addresses and enable NAT traversal. By default, Google's public STUN server is used.

```bash
# On nitellad - use custom STUN server
./nitellad --hub hub.example.com:50052 --stun stun:stun.twilio.com:3478

# On CLI - use custom STUN server
nitella --stun stun:global.stun.twilio.com:3478 node <node-id>

# Via environment variable (works for both)
export NITELLA_STUN="stun:stun.cloudflare.com:3478"
./nitellad --hub hub.example.com:50052
```

**Available public STUN servers:**
| Provider | URL |
|----------|-----|
| Google (default) | `stun:stun.l.google.com:19302` |
| Twilio | `stun:global.stun.twilio.com:3478` |
| Cloudflare | `stun:stun.cloudflare.com:3478` |
| Mozilla | `stun:stun.services.mozilla.com:3478` |

### Disabling P2P

```bash
# On nitellad
./nitellad --hub hub.example.com:50052 --hub-p2p=false

# On CLI (Hub relay mode is used when P2P fails, no CLI flag needed)
nitella node <node-id> status
```

### P2P Authentication

P2P connections use certificate-based mutual authentication:

1. **Certificate Exchange**: Both peers exchange their CA-signed certificates during the WebRTC data channel handshake
2. **CA Verification**: Each peer verifies the other's certificate is signed by the same trusted CA (the user's CA from pairing)
3. **Challenge-Response**: After certificate verification, peers complete a challenge-response to prove possession of the private key
4. **No TOFU**: Unknown certificates are rejected - all nodes must have valid CA-signed certificates from the pairing process

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  CLI    â”‚                           â”‚ nitelladâ”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                           â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
     â”‚                                     â”‚
     â”‚  1. AuthChallenge + CertPEM         â”‚
     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
     â”‚                                     â”‚
     â”‚     Verify cert signed by CA        â”‚
     â”‚                                     â”‚
     â”‚  2. AuthResponse + CertPEM + Sig    â”‚
     â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
     â”‚                                     â”‚
     â”‚  Verify cert signed by CA           â”‚
     â”‚  Verify signature on challenge      â”‚
     â”‚                                     â”‚
     â”‚  3. AuthSuccess                     â”‚
     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
     â”‚                                     â”‚
     â”‚  â•â•â•â•â•â• Authenticated Channel â•â•â•â•â•â•â”‚
     â”‚                                     â”‚
```

**Security guarantees:**
- MITM attacks are prevented because attackers cannot forge CA-signed certificates
- Both peers must possess certificates signed by the user's CA (established during pairing)
- Authentication is required by default (`requireAuth: true`)

## Connection Approval

Nodes can require real-time user approval for incoming connections using `ACTION_TYPE_REQUIRE_APPROVAL`. Approval requests flow through Hub (E2E encrypted) or P2P.

### CLI Commands

```bash
# Alerts stream automatically in background when CLI starts

# List pending approval requests
nitella pending

# Approve a connection (default: cache mode, 5 min)
nitella approve <request_id>
nitella approve cache <request_id> 1h    # Cache approval for 1 hour
nitella approve once <request_id>        # Allow this connection only

# Deny a connection (default: connection-only)
nitella deny <request_id>
nitella deny cache <request_id> 1h       # Cache denial for 1 hour
nitella deny <request_id> "Suspicious"   # Deny with reason
```

**Retention modes:**
- `cache` â€” Decision cached for duration; future connections from same source IP auto-handled
- `once` / `single` / `conn` â€” Decision applies only to this connection

**Duration formats:** `10s`, `1m`, `5m`, `10m`, `1h`, `1d`, `1w`, `1y`

**Note:** Global IP blocking/allowing (`block`, `allow`, `global-rules`) commands work locally on nitellad, not via Hub. Use `nitella send <node-id> block <ip>` to send commands to remote nodes.

### E2E Encryption

Approval requests and decisions are E2E encrypted:
- Hub cannot read which IP is requesting access
- Hub cannot forge or modify approval decisions
- Decisions are cryptographically signed by the CLI

For detailed documentation, see [APPROVAL_SYSTEM.md](APPROVAL_SYSTEM.md).

## Tiers

Hub supports tiered rate limiting and feature gating:

| Tier | Nodes | Rate Limit | Features |
|------|-------|------------|----------|
| Free | 3 | 100 req/min | Basic |
| Pro | 10 | 1000 req/min | P2P, Templates |
| Business | 50 | 10000 req/min | All features |

### Tier-Based Log Limits

Each tier has specific log storage limits:

| Tier | Max Logs | Retention | Storage Estimate |
|------|----------|-----------|------------------|
| Free | 10,000 | 7 days | ~5 MB |
| Pro | 1,000,000 | 30 days | ~500 MB |
| Business | Unlimited | 365 days | Configurable |

When the log limit is reached, the oldest logs are automatically pruned (keeping 90% of the limit).

---

## Encrypted Logs

Hub supports zero-trust encrypted log storage. Nodes push E2E encrypted log entries that the Hub stores but cannot decrypt.

### Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  nitellad   â”‚         â”‚    HUB      â”‚         â”‚    CLI      â”‚
â”‚   (Node)    â”‚         â”‚(Blind Store)â”‚         â”‚  (Decrypt)  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚                       â”‚                       â”‚
       â”‚  PushLogs {           â”‚                       â”‚
       â”‚    node_id: "x"       â”‚                       â”‚
       â”‚    encrypted: <blob>  â”‚                       â”‚
       â”‚  }                    â”‚                       â”‚
       â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                       â”‚
       â”‚                       â”‚                       â”‚
       â”‚                       â”‚  Store encrypted blob â”‚
       â”‚                       â”‚  (cannot decrypt)     â”‚
       â”‚                       â”‚                       â”‚
       â”‚                       â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
       â”‚                       â”‚  GetLogs request      â”‚
       â”‚                       â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
       â”‚                       â”‚  Return encrypted     â”‚
       â”‚                       â”‚                       â”‚
       â”‚                       â”‚                       â”‚  Decrypt with
       â”‚                       â”‚                       â”‚  shared key
```

### Node â†’ Hub Log Push

Nodes stream encrypted log entries using `PushLogs`:

```protobuf
message EncryptedLogEntry {
  string node_id = 1;
  google.protobuf.Timestamp timestamp = 2;
  EncryptedPayload encrypted = 3;  // E2E encrypted LogEntry
}

service NodeService {
  rpc PushLogs(stream EncryptedLogEntry) returns (google.protobuf.Empty);
}
```

### What Hub Stores

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      ENCRYPTED_LOGS TABLE                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ node_id    â”‚ routing_token   â”‚ encrypted_blob   â”‚ timestampâ”‚    â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”‚
â”‚  â”‚ node-a     â”‚ a7f3b2c1d4...   â”‚ <encrypted>      â”‚ 2024-... â”‚    â”‚
â”‚  â”‚ node-b     â”‚ x9y8z7w6v5...   â”‚ <encrypted>      â”‚ 2024-... â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                     â”‚
â”‚  Hub CAN see:     âœ“ node_id, routing_token, timestamp, blob size   â”‚
â”‚  Hub CANNOT see:  âœ— log content, log level, log message            â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### CLI Commands for Logs

```bash
# View logs statistics
nitella logs stats

# List logs by routing token
nitella logs list <routing_token>

# List logs with filters
nitella logs list <routing_token> --node <node_id> --limit 100

# Delete logs by routing token
nitella logs delete <routing_token> --all

# Delete logs with filters
nitella logs delete <routing_token> --node <node_id> --before 2026-01-01

# Cleanup old logs (admin operation)
nitella logs cleanup <days>
nitella logs cleanup 30 --dry-run
```

### Admin API for Logs

The AdminService provides log management APIs:

```protobuf
service AdminService {
  // Get aggregate statistics for all logs
  rpc GetLogsStats(GetLogsStatsRequest) returns (LogsStats);

  // List logs (encrypted) by routing token
  rpc ListLogs(ListLogsRequest) returns (ListLogsResponse);

  // Delete logs by criteria
  rpc DeleteLogs(DeleteLogsRequest) returns (DeleteLogsResponse);

  // Cleanup logs older than X days
  rpc CleanupOldLogs(CleanupOldLogsRequest) returns (CleanupOldLogsResponse);
}

message LogsStats {
  int64 total_logs = 1;
  int64 total_storage_bytes = 2;
  map<string, int64> logs_by_routing_token = 3;
  map<string, int64> storage_by_routing_token = 4;
  google.protobuf.Timestamp oldest_log = 5;
  google.protobuf.Timestamp newest_log = 6;
}
```

### Automatic Cleanup

Hub automatically manages log storage:

1. **Per-tier limits**: When log count exceeds tier limit, oldest logs are pruned
2. **Retention period**: Logs older than tier's retention period are deleted
3. **Manual cleanup**: Admins can trigger cleanup via `CleanupOldLogs` RPC

```bash
# View current log storage status
nitella logs stats

# Example output:
# Total Logs:     45,231
# Storage Used:   23.4 MB
# Oldest Log:     2024-01-15 10:30:00 UTC
# Newest Log:     2024-02-01 18:45:23 UTC
#
# By Routing Token:
#   a7f3b2...: 12,345 logs (6.2 MB)
#   x9y8z7...: 32,886 logs (17.2 MB)
```

## Monitoring

### Health Endpoints

```bash
# Liveness
curl http://hub:8080/health

# Readiness
curl http://hub:8080/ready
```

### Metrics

Hub exposes Prometheus-compatible metrics (when enabled):

```
hub_nodes_total
hub_nodes_online
hub_connections_active
hub_commands_total
hub_commands_errors
```

## Troubleshooting

### Node won't register

1. Check Hub is reachable: `curl https://hub:50052/health`
2. Verify invite code is valid and not expired
3. Check node logs for TLS errors
4. Ensure clocks are synchronized (within 60 seconds)

### Commands not reaching node

1. Verify node is online: `nitella nodes`
2. Check node certificate hasn't expired
3. Try P2P mode: `nitella node <id> --p2p`
4. Check Hub logs for relay errors

### P2P connection failing

1. Check firewall allows UDP
2. Try a different STUN server: `--stun stun:stun.cloudflare.com:3478`
3. If behind restrictive NAT, some STUN servers may work better than others
4. Try Hub relay mode: `--no-p2p`

## Hub Migration

Migrating to a new Hub provider is straightforward because Nitella uses a zero-trust architecture where the Hub is just a "dumb relay" - your cryptographic identity (keys and certificates) stays on your devices and is fully portable.

### Why Migration Works

| Component | Stored Location | Portable? |
|-----------|----------------|-----------|
| CLI Root CA (private key) | Your machine (`~/.nitella/`) | âœ… Yes |
| CLI Root Certificate | Your machine | âœ… Yes |
| Node Private Key | Node server (`~/.nitella/`) | âœ… Yes |
| Node Certificate (signed by your CA) | Node server | âœ… Yes |
| Proxy Templates (encrypted) | Hub storage | âœ… Export & re-push |
| Routing Tokens | Derived from your keys | âœ… Auto-generated |
| Hub CA Certificate | Hub-specific | âŒ Replaced by new Hub |

### CLI Migration

```bash
# 1. Export your proxy templates from the old Hub first
nitella proxy list
nitella proxy export <proxy-id> --output backup.yaml

# 2. Configure new Hub address
nitella config set hub newhub.example.com:50052

# 3. Register with the new Hub (uses your existing identity)
nitella register
# Verify the new Hub's fingerprint when prompted!

# 4. Push your templates to the new Hub
nitella proxy push <proxy-id>
```

Your CLI identity (Root CA) stays the same - you're just telling the new Hub about your public key.

### Node Migration

**No re-pairing required!** Nodes with valid certificates can connect to any Hub:

```bash
# On each node server - just restart with the new Hub address
nitellad --hub newhub.example.com:50052
```

The node will:
1. Use its existing certificate (already signed by your CA)
2. Connect to the new Hub with mTLS
3. Register its routing token automatically

### Proxy Template Migration

```bash
# Export all templates locally (before switching)
for proxy in $(nitella proxy list --ids); do
    nitella proxy export $proxy --output "$proxy.yaml"
done

# After switching to new Hub, push each one
for file in *.yaml; do
    nitella proxy import $file
    nitella proxy push $(basename $file .yaml)
done
```

### Migration Checklist

```
[ ] Export all proxy templates from old Hub
[ ] Configure CLI with new Hub address
[ ] Register CLI with new Hub (verify fingerprint!)
[ ] Push templates to new Hub
[ ] Restart each nitellad node with new Hub address
[ ] Test commands work end-to-end
```

### What You DON'T Need to Do

- âŒ Re-pair nodes with PAKE/QR code (certificates are portable)
- âŒ Generate new keys (your identity is preserved)
- âŒ Transfer any secrets (the new Hub never sees them)

## Development

### Running Tests

```bash
cd /path/to/nitella
go test ./pkg/hub/...
go test ./pkg/hubclient/...
```

### Building

```bash
# Hub server
go build -o hub ./cmd/hub

# Hub admin CLI
go build -o hubctl ./cmd/hubctl

# Nitella CLI (with Hub support)
go build -o nitella ./cmd/nitella

# Nitellad (with Hub support)
go build -o nitellad ./cmd/nitellad
```
